<div class="d-flex flex-wrap gap-2 mb-3">
  <% [["24h", t("websites.show.ranges.24h")],
      ["7d", t("websites.show.ranges.7d")],
      ["30d", t("websites.show.ranges.30d")],
      ["all", t("websites.show.ranges.all")]].each do |range_value, label| %>
    <%= link_to label,
                website_path(@website, range: range_value, failed: (@show_failed_only ? "true" : nil)),
                class: "btn filter-button #{@time_range == range_value ? 'active' : ''}",
                data: { turbo_stream: true } %>
  <% end %>
</div>

<div class="stat-grid mb-4">
  <div class="stat-card stat-card--center">
    <span class="stat-card__label"><%= t("websites.show.total_responses_label") %></span>
    <span class="stat-card__value"><%= @website.response_count %></span>
    <p class="mb-0 surface-subtitle"><%= t("websites.show.total_responses_subtitle") %></p>
  </div>

  <div class="stat-card stat-card--center">
    <span class="stat-card__label"><%= t("websites.show.failed_in_range_label") %></span>
    <span class="stat-card__value"><%= @failed_responses_total %></span>
    <p class="mb-0 surface-subtitle"><%= t("websites.show.failed_in_range_subtitle", range: @range_label) %></p>
  </div>

  <% if @website.responses.any? %>
    <div class="stat-card stat-card--center">
      <span class="stat-card__label"><%= t("websites.show.last_response_label") %></span>
      <span class="stat-card__value"><%= @website.latest_response.status_code %></span>
      <p class="mb-0 surface-subtitle">
        <%= @website.latest_response.created_at.in_time_zone("Eastern Time (US & Canada)").strftime("%b %d, %Y %l:%M %p") %>
      </p>
    </div>
  <% end %>
</div>

<% if @website.response_count > 0 %>
  <section class="surface-block surface-block--nested mb-4">
    <div class="surface-header w-100 align-items-start">
      <div>
        <p class="surface-eyebrow"><%= t("websites.show.timeline_eyebrow") %></p>
        <h3 class="surface-title"><%= t("websites.show.timeline_title") %></h3>
        <p class="surface-subtitle"><%= t("websites.show.timeline_subtitle", range: @range_label) %></p>
      </div>
    </div>

    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-card__header">
          <div>
            <p class="chart-card__label"><%= t("websites.show.latency_trend_label") %></p>
            <p class="chart-card__value">
              <%= @latency_series.last&.dig(:value)&.round(2) || t("websites.show.no_value") %> ms
            </p>
            <% if @latency_series.any? %>
              <p class="chart-card__meta">
                <%= t("websites.show.latency_meta",
                      avg: @latency_stats[:avg].to_f.round(1),
                      max: @latency_stats[:max].to_f.round(1)) %>
              </p>
            <% end %>
          </div>
          <span class="chart-chip"><%= t("websites.show.latest_points", count: @latency_series.size) %></span>
        </div>

        <% if @latency_series.any? %>
          <% height = 160 %>
          <% min_chart_width = 320 %>
          <% max_chart_width = 840 %>
          <% width_step = if @latency_series.size > 1
                            [18, (max_chart_width - 12).to_f / (@latency_series.size - 1)].min
                          else
                            0
                          end %>
          <% chart_width = [((@latency_series.size - 1) * width_step + 12), min_chart_width].max %>
          <% baseline = height - 20 %>
          <% max_value = [@latency_stats[:max].to_f, 1].max %>
          <% points_with_coords = @latency_series.each_with_index.map do |point, idx|
               x = idx * width_step
               y = baseline - ((point[:value].to_f / max_value) * 110)
               { x: x, y: y.round(2), value: point[:value] }
             end %>
          <% points = points_with_coords.map { |point| "#{point[:x]},#{point[:y]}" }.join(' ') %>
          <% area_points = "0,#{baseline} #{points} #{chart_width},#{baseline}" %>
          <% ticks = [@latency_stats[:max], (@latency_stats[:max].to_f + @latency_stats[:min].to_f) / 2.0, @latency_stats[:min]].compact.uniq %>

          <svg class="timeline-chart" width="100%" height="<%= height %>" viewBox="0 0 <%= chart_width %> <%= height %>" preserveAspectRatio="none">
            <defs>
              <linearGradient id="latency-fill" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="var(--color-forest-200)" stop-opacity="0.8" />
                <stop offset="100%" stop-color="var(--color-forest-100)" stop-opacity="0.35" />
              </linearGradient>
            </defs>

            <% ticks.each do |tick| %>
              <% y = baseline - ((tick.to_f / max_value) * 110) %>
              <line x1="0" y1="<%= y.round(2) %>" x2="<%= chart_width %>" y2="<%= y.round(2) %>" stroke="var(--color-outline)" stroke-dasharray="4 4" stroke-width="1" />
              <text x="0" y="<%= (y - 4).round(2) %>" fill="var(--color-muted)" font-size="10"><%= "#{tick.to_f.round(1)} ms" %></text>
            <% end %>

            <polygon points="<%= area_points %>" fill="url(#latency-fill)" />
            <polyline points="<%= points %>" fill="none" stroke="var(--color-forest-400)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />

            <% points_with_coords.each do |point| %>
              <circle cx="<%= point[:x] %>" cy="<%= point[:y] %>" r="3" fill="var(--color-forest-400)" />
            <% end %>
          </svg>

          <p class="chart-caption"><%= t("websites.show.latency_caption", count: @latency_series.size) %></p>
        <% else %>
          <p class="surface-subtitle mb-0"><%= t("websites.show.no_latency_data") %></p>
        <% end %>
      </div>
    </div>
  </section>

  <div class="response-controls d-flex flex-wrap align-items-center gap-2 mb-4">
    <%= link_to t("websites.show.show_all"),
                website_path(@website, range: @time_range),
                class: "btn filter-button #{@show_failed_only ? '' : 'active'}",
                data: { turbo_stream: true } %>
    <%= link_to t("websites.show.show_failed"),
                website_path(@website, range: @time_range, failed: true),
                class: "btn filter-button filter-button--alert #{@show_failed_only ? 'active' : ''}",
                data: { turbo_stream: true } %>

    <% if @show_failed_only %>
      <p class="surface-subtitle mb-0 response-controls__note"><%= t("websites.show.showing_failed_range", range: @range_label) %></p>
    <% end %>
  </div>

  <section class="surface-block surface-block--nested">
    <%= render "responses_table", website: @website, responses: @responses, pagination_params: @pagination_params, empty_message: @empty_message %>
  </section>
<% else %>
  <p class="surface-subtitle mb-0">
    <%= t("websites.show.no_responses_yet") %>
  </p>
<% end %>
