<% content_for :body_class, "admin-archives" %>

<div class="container-xl">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h1 class="h4 mb-3"><%= t("admin.archives.heading") %></h1>

      <p class="text-muted mb-3">
        <%= t("admin.archives.description") %>
      </p>

      <div class="alert alert-info py-2" role="alert">
        <ul class="mb-0 small ps-3">
          <li><%= t("admin.archives.info_automatic_upload") %></li>
          <li><%= t("admin.archives.info_manual_upload") %></li>
          <li><%= t("admin.archives.info_no_credentials") %></li>
        </ul>
      </div>

      <div class="alert alert-warning py-2" role="alert">
        <small>
          <%= t("admin.archives.warning") %>
        </small>
      </div>

      <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
        <div>
          <p class="mb-1 fw-semibold"><%= t("admin.archives.s3_status") %></p>

          <% if @s3_ready %>
            <span class="badge bg-success">
              <% if @aws_setting&.bucket.present? %>
                <%= t("admin.archives.configured_for_bucket") %> <%= @aws_setting.bucket %>

                <% if @aws_setting.key_prefix.present? %>
                  <span class="text-muted">(<%= t("admin.archives.prefix_label") %> <%= @aws_setting.key_prefix %>)</span>
                <% end %>
              <% else %>
                <%= t("admin.archives.configured") %>
              <% end %>
            </span>

            <% if @aws_setting&.updated_at %>
              <p class="text-muted small mb-0 mt-1">
                <%= t("admin.archives.credentials_last_saved") %> <%= l(@aws_setting.updated_at, format: :long) %>
              </p>
              <p class="text-muted small mb-0">
                <%= t("admin.archives.credentials_reuse_hint") %>
              </p>
            <% end %>
          <% else %>
            <span class="badge bg-secondary"><%= t("admin.archives.not_connected") %></span>
          <% end %>
        </div>

        <%= link_to t("admin.archives.configure_aws"), admin_aws_settings_path, class: "btn btn-outline-secondary" %>
        <%= button_to t("admin.archives.archive_now"), export_admin_archives_path, method: :post, class: "btn btn-primary ms-md-auto" %>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h5 mb-3"><%= t("admin.archives.existing_csvs") %></h2>

      <% if @archive_files.any? %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th scope="col"><%= t("admin.archives.filename") %></th>
                <th scope="col"><%= t("admin.archives.generated") %></th>
                <th scope="col"><%= t("admin.archives.size") %></th>
                <th scope="col" class="text-end"><%= t("admin.archives.actions") %></th>
              </tr>
            </thead>
            <tbody>
              <% @archive_files.each do |file| %>
                <tr>
                  <td><%= file.name %></td>
                  <td><%= l(file.mtime, format: :long) %></td>
                  <td><%= number_to_human_size(file.size) %></td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      <%= link_to t("admin.archives.download"), download_admin_archives_path(filename: file.name), class: "btn btn-outline-secondary btn-sm" %>

                      <% if @s3_ready %>
                        <%= button_to t("admin.archives.upload_to_s3"),
                            upload_admin_archives_path(filename: file.name),
                            method: :post,
                            form: { data: { turbo_confirm: t("admin.archives.upload_confirm", filename: file.name) } },
                            class: "btn btn-success btn-sm" %>
                      <% else %>
                        <button class="btn btn-success btn-sm" disabled title="<%= t("admin.archives.connect_first_title") %>">
                          <%= t("admin.archives.upload_to_s3") %>
                        </button>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted mb-2"><%= t("admin.archives.no_archives") %></p>

        <p class="text-muted small mb-0">
          <%= t("admin.archives.local_csvs_written_to") %> <code><%= @archive_directory %></code>
          <%= t("admin.archives.on_this_server") %>

          <% if @s3_ready %>
            <%= t("admin.archives.removed_after_upload") %>
            <code>
              <%= @aws_setting&.bucket %>
              <%= "/" if @aws_setting&.bucket.present? && @aws_setting&.key_prefix.present? %>
              <%= @aws_setting&.key_prefix %>
            </code>
            <%= t("admin.archives.earlier_runs") %>
          <% else %>
            <%= t("admin.archives.filesystem_warning") %>
          <% end %>
        </p>
      <% end %>
    </div>
  </div>
</div>
